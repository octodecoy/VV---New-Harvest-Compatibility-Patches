<?xml version="1.0" encoding="utf-8"?>
<Patch>
    <!-- Add the original category plus the dummy category to begin with so when/if we add the dummy category to 
         recipes and etc. where mod categories reside, our things will be included too.
         If merge setting is on, we replace the original category so that only the dummy category is left, 
         and add a parent to the dummy category so that its children will now be visible, and the
         dummy category will now be a real category.  -->
    <Operation Class="NewHarvestPatches.AddOrReplace">
        <xpath>
            /Defs/ThingDef
            [defName="VV_CashewNuts" or 
            defName="VV_Chestnuts" or 
            defName="VV_Hazelnuts" or 
            defName="VV_PineNuts" or 
            defName="VV_Pecans" or 
            defName="VV_Walnuts"]
        </xpath>
        <value>
            <thingCategories Inherit="False">
                <li>PlantFoodRaw</li>
                <li>VV_NHCP_DummyCategory_Nuts</li>
            </thingCategories>
        </value>
    </Operation> 
    <!-- Check if there are supposed mod added categories, and if so, add our dummy category to recipes/storages/traders containing them. -->
    <Operation Class="NewHarvestPatches.TestCategory">
        <xpath>/Defs/ThingCategoryDef[parent="Foods" or parent="FoodRaw" or parent="PlantFoodRaw"]</xpath>
        <categoryType>Nuts</categoryType>  
        <caseTrue Class="PatchOperationSequence">
            <operations>
                <li Class="NewHarvestPatches.AddCategoryToFilter">
                    <success>Always</success>
                    <xpath>/Defs/RecipeDef/ingredients/li/filter/categories[not(li="VV_NHCP_DummyCategory_Nuts")]</xpath>
                    <categoryType>Nuts</categoryType>                    
                </li>
                <li Class="NewHarvestPatches.AddCategoryToFilter">
                    <success>Always</success>
                    <xpath>/Defs/RecipeDef/fixedIngredientFilter/categories[not(li="VV_NHCP_DummyCategory_Nuts")]</xpath>
                    <categoryType>Nuts</categoryType>
                </li>
                <li Class="NewHarvestPatches.AddCategoryToFilter">
                    <success>Always</success>
                    <xpath>/Defs/RecipeDef/defaultIngredientFilter/categories[not(li="VV_NHCP_DummyCategory_Nuts")]</xpath>
                    <categoryType>Nuts</categoryType>
                </li>
                <li Class="NewHarvestPatches.AddCategoryToFilter">
                    <success>Always</success>
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter/categories[not(li="VV_NHCP_DummyCategory_Nuts")]</xpath>
                    <categoryType>Nuts</categoryType>
                </li>
                <li Class="NewHarvestPatches.AddCategoryToFilter">
                    <success>Always</success>
                    <xpath>/Defs/ThingDef/building/defaultStorageSettings/filter/categories[not(li="VV_NHCP_DummyCategory_Nuts")]</xpath>
                    <categoryType>Nuts</categoryType>
                </li>
                <li Class="PatchOperationFindMod">
                    <mods>
                        <li>[SYR] Processor Framework</li>
                    </mods>
                    <match Class="NewHarvestPatches.AddCategoryToFilter">
                        <success>Always</success>
                        <xpath>/Defs/ProcessorFramework.ProcessDef/ingredientFilter/categories[not(li="VV_NHCP_DummyCategory_Nuts")]</xpath>
                        <categoryType>Nuts</categoryType>
                    </match>
                </li>
                <li Class="NewHarvestPatches.ConditionalSetting">
                    <setting>MergeNutsCategory</setting>
                    <caseTrue Class="NewHarvestPatches.CloneStockWithNewCategory">
                        <success>Always</success>
                        <xpath>/Defs/TraderKindDef/stockGenerators[not(li[@Class="StockGenerator_Category"]/categoryDef="VV_NHCP_DummyCategory_Nuts")]/li[@Class="StockGenerator_Category"]</xpath>
                        <categoryType>Nuts</categoryType>
                        <zeroOutOriginal>true</zeroOutOriginal>                      
                    </caseTrue>
                </li>
            </operations>
        </caseTrue>
    </Operation>
    <Operation Class="NewHarvestPatches.ConditionalSetting">
        <setting>MergeNutsCategory</setting>
        <caseTrue Class="PatchOperationSequence">
            <operations>
                <!-- Make category visible to UI -->
                <li Class="NewHarvestPatches.AddOrReplace">
                    <xpath>/Defs/ThingCategoryDef[defName="VV_NHCP_DummyCategory_Nuts"]</xpath>
                    <value>
                        <parent>PlantFoodRaw</parent>
                    </value>
                </li>     
                <li Class="NewHarvestPatches.TryReplaceCategoriesWithCategoryOfType">
                    <xpath>
                        /Defs/ThingDef
                        [defName="VV_CashewNuts" or 
                        defName="VV_Chestnuts" or 
                        defName="VV_Hazelnuts" or 
                        defName="VV_PineNuts" or 
                        defName="VV_Pecans" or 
                        defName="VV_Walnuts"]
                    </xpath>
                    <categoryType>Nuts</categoryType>                          
                </li>   
                <li Class="PatchOperationFindMod">
                    <mods>
                        <li>Vanilla Plants Expanded - More Plants</li>
                    </mods>    
                    <match Class="NewHarvestPatches.TryReplaceCategoriesWithCategoryOfType">
                        <xpath>
                            /Defs/ThingDef
                            [defName="VCE_RawPeanut" or 
                            defName="VCE_RawSunflower" or 
                            defName="VCE_RawLotus" or 
                            defName="VCE_RawAlmonds"]
                        </xpath>
                        <categoryType>Nuts</categoryType>                         
                    </match>   
                </li>
                <li Class="NewHarvestPatches.HasModAddedCategoryOfType">
                    <success>Always</success>
                    <categoryType>Nuts</categoryType>
                    <caseTrue Class="NewHarvestPatches.TryReplaceCategoryChildrenWithCategoryOfType">
                        <categoryType>Nuts</categoryType>
                    </caseTrue>
                </li> 
                <!-- This can only be true if Merge setting is true -->
                <li Class="NewHarvestPatches.ConditionalSetting">
                    <setting>NutsCategoryResourceReadout</setting>
                    <caseTrue Class="NewHarvestPatches.AddOrReplace">
                        <xpath>/Defs/ThingCategoryDef[defName="VV_NHCP_DummyCategory_Nuts"]</xpath>
                        <value>
                            <resourceReadoutRoot>true</resourceReadoutRoot>
                        </value>
                    </caseTrue>
                </li> 
            </operations>
        </caseTrue>
    </Operation>
</Patch>