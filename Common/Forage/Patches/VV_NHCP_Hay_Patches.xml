<?xml version="1.0" encoding="utf-8"?>
<Patch>
    <!-- RECIPES -->
    <Operation Class="PatchOperationSequence">
        <operations>
            <!-- DISALLOWED -->
            <li Class="PatchOperationAdd">
                <success>Always</success>
                <xpath>
                    /Defs/RecipeDef/ingredients/li/filter/disallowedThingDefs
                    [li="Hay"]
                    [not(li="VV_AlfalfaHay")]
                </xpath>
                <value>
                    <li>VV_AlfalfaHay</li>
                    <li>VV_CloverHay</li>
                    <li>VV_TimothyHay</li>
                </value>
            </li>
            <li Class="PatchOperationAdd">
                <success>Always</success>
                <xpath>
                    /Defs/RecipeDef
                    [ingredients/li/filter/disallowedThingDefs/li="Hay"]
                    /fixedIngredientFilter/disallowedThingDefs
                    [not(li="VV_AlfalfaHay")]
                </xpath>
                <value>
                    <li>VV_AlfalfaHay</li>
                    <li>VV_CloverHay</li>
                    <li>VV_TimothyHay</li>
                </value>
            </li>
            <!-- ALLOWED -->
            <li Class="PatchOperationAdd">
                <success>Always</success>
                <xpath>                    
                    /Defs/RecipeDef/ingredients/li/filter/thingDefs
                    [li="Hay"]
                    [not(li="VV_AlfalfaHay")]
                </xpath>
                <value>
                    <li>VV_AlfalfaHay</li>
                    <li>VV_CloverHay</li>
                    <li>VV_TimothyHay</li>
                </value>
            </li>
            <li Class="PatchOperationAdd">
                <success>Always</success>
                <xpath>                    
                    /Defs/RecipeDef
                    [not(fixedIngredientFilter)]
                    [ingredients/li/filter/thingDefs/li="VV_AlfalfaHay"]
                </xpath> 
                <value>
                    <fixedIngredientFilter>
                        <thingDefs />
                    </fixedIngredientFilter>
                </value>               
            </li>
            <li Class="PatchOperationAdd">
                <success>Always</success>
                <xpath>                    
                    /Defs/RecipeDef
                    [fixedIngredientFilter and not(fixedIngredientFilter/thingDefs)]
                    [ingredients/li/filter/thingDefs/li="VV_AlfalfaHay"]
                    /fixedIngredientFilter
                </xpath> 
                <value>
                    <thingDefs />
                </value>               
            </li>
            <li Class="PatchOperationAdd">
                <success>Always</success>
                <xpath>                        
                    /Defs/RecipeDef
                    [fixedIngredientFilter/thingDefs]
                    [ingredients/li/filter/thingDefs[li="Hay" and li="VV_AlfalfaHay"]]
                    /fixedIngredientFilter/thingDefs
                    [not(li="Hay")]
                </xpath>
                <value>
                    <li>Hay</li>
                </value>
            </li>
            <li Class="PatchOperationAdd">
                <success>Always</success>
                <xpath>                        
                    /Defs/RecipeDef
                    [fixedIngredientFilter/thingDefs]
                    [ingredients/li/filter/thingDefs/li="VV_AlfalfaHay"]
                    /fixedIngredientFilter/thingDefs
                    [not(li="VV_AlfalfaHay")]
                </xpath>
                <value>
                    <li>VV_AlfalfaHay</li>
                    <li>VV_CloverHay</li>
                    <li>VV_TimothyHay</li>
                </value>
            </li>
            <li Class="PatchOperationAdd">
                <success>Always</success>
                <xpath>
                    /Defs/RecipeDef
                    [not(defaultIngredientFilter)]
                    [fixedIngredientFilter/thingDefs[li="VV_AlfalfaHay"]]
                </xpath>
                <value>
                    <defaultIngredientFilter>
                        <thingDefs />
                    </defaultIngredientFilter>
                </value>
            </li>
            <li Class="PatchOperationAdd">
                <success>Always</success>
                <xpath>
                    /Defs/RecipeDef
                    [defaultIngredientFilter and not(defaultIngredientFilter/thingDefs)]
                    [fixedIngredientFilter/thingDefs[li="VV_AlfalfaHay"]]
                    /defaultIngredientFilter
                </xpath>
                <value>
                    <thingDefs />
                </value>
            </li>
            <li Class="PatchOperationAdd">
                <success>Always</success>
                <xpath>                        
                    /Defs/RecipeDef
                    [defaultIngredientFilter/thingDefs]
                    [fixedIngredientFilter/thingDefs[li="Hay" and li="VV_AlfalfaHay"]]
                    /defaultIngredientFilter/thingDefs
                    [not(li="Hay")]
                </xpath>
                <value>
                    <li>Hay</li>
                </value>
            </li>
            <li Class="PatchOperationAdd">
                <success>Always</success>
                <xpath>                        
                    /Defs/RecipeDef
                    [fixedIngredientFilter/thingDefs/li="VV_AlfalfaHay"]
                    /defaultIngredientFilter/thingDefs
                    [li="Hay"]
                    [not(li="VV_AlfalfaHay")]
                </xpath>
                <value>
                    <li>VV_AlfalfaHay</li>
                    <li>VV_CloverHay</li>
                    <li>VV_TimothyHay</li>
                </value>
            </li>
            <!-- Animal Foods Extended's Grazing Feedstock recipe doesn't work when added to because of its CookMealBase parent, 
                 more specifically CookMealBase's specialFiltersToDisallow=AllowPlantFood. -->
            <li Class="PatchOperationFindMod">
                <mods>
                    <li>Animal Foods Extended</li>
                </mods>
                <match Class="PatchOperationAdd">
                    <xpath>
                        /Defs/RecipeDef
                        [defName="CookFeedstockGrazing" or defName="CookFeedstockGrazingBulk"]
                        /fixedIngredientFilter
                        [thingDefs/li="VV_AlfalfaHay"]
                    </xpath>
                    <value>
                        <specialFiltersToDisallow Inherit="False" />
                    </value>
                </match>                                
            </li>
            <!-- STORAGES -->
            <li Class="PatchOperationAdd">
                <success>Always</success>
                <xpath>
                    /Defs/ThingDef/building/fixedStorageSettings/filter/thingDefs
                    [li="Hay"]
                    [not(li="VV_AlfalfaHay")]
                </xpath>
                <value>
                    <li>VV_AlfalfaHay</li>
                    <li>VV_CloverHay</li>
                    <li>VV_TimothyHay</li>
                </value>
            </li>
            <li Class="PatchOperationAdd">
                <success>Always</success>
                <xpath>
                    /Defs/ThingDef/building
                    [defaultStorageSettings]
                    [fixedStorageSettings/filter/thingDefs/li="VV_AlfalfaHay"]
                    /defaultStorageSettings/filter/thingDefs
                    [not(li="VV_AlfalfaHay")]
                </xpath>
                <value>
                    <li>VV_AlfalfaHay</li>
                    <li>VV_CloverHay</li>
                    <li>VV_TimothyHay</li>
                </value>
            </li>
        </operations>
    </Operation>
</Patch>